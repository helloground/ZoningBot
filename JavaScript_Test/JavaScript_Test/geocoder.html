<!DOCTYPE html>
<html>
<head>
    <title>Geocoding service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
        }

        #floating-panel {
            position: absolute;
            top: 10px;
            left: 25%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div id="floating-panel">
        <input id="address" type="textbox" value="Minneapolis, MN">
        <input id="submit" type="button" value="Geocode">
    </div>
    <div id="map"></div>
    
   </script>
    <script>
        //Set global lat and lng variables
        var locationJSON_lat;
        var locationJSON_lng;
        //Create Zoning Feature Collection object
        var ZoningFeatureCollection;

        //Set city. add to this later to expand for more sites
        var city = "Minneapolis";
        //create map
      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: {lat: 44.9778, lng: -93.2650}
        });
        var geocoder = new google.maps.Geocoder();

        document.getElementById('submit').addEventListener('click', function() {
            geocodeAddress(geocoder, map);
            //run dataPull to collect zone data
            dataPull();
            console.log(ZoningFeatureCollection);
            //try turf inside fuction
            IDZone(locationJSON_lat, locationJSON_lng, ZoningFeatureCollection);
            
        });
      }
        //geocode address
      function geocodeAddress(geocoder, resultsMap) {
        var address = document.getElementById('address').value;
        geocoder.geocode({'address': address}, function(results, status) {
          if (status === 'OK') {
            resultsMap.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
              map: resultsMap,
              position: results[0].geometry.location
            });
            locationJSON_lat = results[0].geometry.location.lat();
            locationJSON_lng = results[0].geometry.location.lng();
            console.log("lat : " + locationJSON_lat + " lng : " + locationJSON_lng);
              //alert(results[0].geometry.location.lat());
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
        
      }
        //Cast lat,lng into GeoJSON point object
      function latlngToGeoJSON(lat, lng) {
          //var GeoJSONpoint_address = { "type": "Point", "coordinates": [lat, lng] };
          var point = {
              "type": "Feature",
              "geometry": {
                  "type": "Point",
                  "coordinates": [lng, lat]
              }
          };
          return point;
      }
      

        function dataPull() {
            //Pulls in zoning GeoJSON data for Minneapolis

          //Look into sync issues
          //hardcoded data source for geojson zoning map data
          var url = 'http://opendata.minneapolismn.gov/datasets/9e0d092ecdfd4089b2ef3021e739f8c7_0.geojson';
         
          // jQuery cross domain ajax
          $.get(url).done(function (data) {
              //console.log(data);
              ZoningFeatureCollection = data;
              //console.log(ZoningFeatureCollection);
          });
          //ZoningFeatureCollection = response.responseJSON[responseJSON];
          //console.log(data);
          //console.log(ZoningFeatureCollection);

          // using XMLHttpRequest
          /*var xhr = new XMLHttpRequest();
          xhr.open("GET", url, true);
          xhr.onload = function () {
              console.log(xhr.responseText);
          };
          xhr.send();*/
          
          return ZoningFeatureCollection;
      }

        //IDZone Test Data
        //var pt2 = {
        //    "type": "Feature",
        //    "properties": {
        //        "marker-color": "#0f0"
        //    },
        //    "geometry": {
        //        "type": "Point",
        //        "coordinates": [-111.873779, 40.647303]
        //    }
        //};
        //var poly = {
        //    "type": "Feature",
        //    "properties": {},
        //    "geometry": {
        //        "type": "Polygon",
        //        "coordinates": [[
        //          [-112.074279, 40.52215],
        //          [-112.074279, 40.853293],
        //          [-111.610107, 40.853293],
        //          [-111.610107, 40.52215],
        //          [-112.074279, 40.52215]
        //        ]]
        //    }
        //};
        //function Tester(pt, poly) {
        //    var isInside2 = turf.inside(pt2, poly);
        //    //=isInside2
        //    return isInside2;

        //}


        function IDZone(lat, lng, featureCollection) {
            //identifies what zone address is in
            //Basic Test use turf to say yes or no with 'inside'


           

           var point = latlngToGeoJSON(lat, lng);
            //console point
           console.log("Point: " + JSON.stringify(point));
           console.log("Feature: " + JSON.stringify(featureCollection.features[0]));
            //console featureCollection
            //console.log("Feature Collection: "+ JSON.stringify(featureCollection.features[0]));
           //console.log("The array is: " + featureCollection.features.length);
           var ArrayLength = featureCollection.features.length;
           var ItIsInside = false;
            //for loop to find what zone address is in
           for (i = 0; i < (ArrayLength); i++) {
               ItIsInside = insideZone(point, featureCollection, i);
               //console.log(insideZone(point, featureCollection, i));
               //console.log("It is inside" + ItIsInside + i);
               if (ItIsInside == true) { break;}
           }
            console.log("It is inside (final)" + ItIsInside + i);
            console.log("Zone: " + JSON.stringify(featureCollection.features[i].properties.ZONE_CODE));
            //why always false?
        }

        //helper function for inside helper
        function insideZone(point,featureCollection,arrayIndex) {
            var isItInside = turf.inside(point, featureCollection.features[arrayIndex]);
            return isItInside;
        }

       
      

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMYxtuNEsa7MyF7YnQ7vNiDmixlfKiWuA&callback=initMap">
    </script>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

   
    <script async defer
             src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'>

    </script>
</body>
</html>